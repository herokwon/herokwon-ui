name: Notion Synchronization

on:
  issues:
    types:
      - opened
      - reopened
      - edited
      - closed
      - assigned
      - unassigned
      - labeled
      - unlabeled

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-existence:
    name: Check existence
    runs-on: ubuntu-latest
    outputs:
      page_id: ${{ steps.notion.outputs.page_id }}
      status: ${{ steps.notion.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check notion database
        id: notion
        run: |
          results=$(curl -X POST "https://api.notion.com/v1/databases/${{ secrets.NOTION_DATABASE_ID }}/query" \
            -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data '{
              "filter": {
                "property": "Link",
                "url": {
                  "equals": "${{ github.event.issue.html_url }}"
                }
              },
              "page_size": 1
            }' | jq -r '.results');

            page_id=""
            status=""

            if [ "$results" != "[]" ]; then
              page_id=$(echo "$results" | jq -r '.[0].id')
              status=$(echo "$results" | jq -r '.[0].properties.Status.select.name')
            fi

            echo "page_id=$page_id" >> $GITHUB_OUTPUT
            echo "status=$status" >> $GITHUB_OUTPUT

  synchronize-with-notion:
    name: Synchronize with notion
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create new page on notion
        run: |
          curl -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data '{
              "parent": {
                "database_id": "${{ secrets.NOTION_DATABASE_ID }}"
              },
              "properties": {
                "Status": {
                  "select": {
                    "name": "Opened"
                  }
                },
                "Title": {
                  "title": [
                    {
                      "text": {
                        "content": "${{ github.event.issue.title }}"  
                      }
                    }  
                  ]    
                },
                "Link": {
                  "url": "${{ github.event.issue.html_url }}"    
                }
              }
            }'
